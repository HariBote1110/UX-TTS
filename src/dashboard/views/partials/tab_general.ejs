<div class="tab-pane fade show active" id="content-general">
    
    <form action="/dashboard/<%= guild.id %>/save" method="POST">
        <div class="card">
            <div class="card-header"><i class="bi bi-person-fill me-2"></i>個人設定 (あなたの設定)</div>
            <div class="card-body">
                
                <% if (presets.length === 0) { %>
                 <div class="mb-3 d-flex justify-content-end">
                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#savePresetModal">
                        <i class="bi bi-bookmark-plus me-1"></i>現在の設定をプリセット保存
                    </button>
                 </div>
                <% } %>

                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-megaphone-fill me-1"></i>話者 (Character)</label>
                    <div class="row g-2">
                        <div class="col-6"><select class="form-select" id="speakerCharSelect"><option>Loading...</option></select></div>
                        <div class="col-6"><select class="form-select" id="speakerStyleSelect"><option>Loading...</option></select></div>
                    </div>
                    <input type="hidden" name="speakerSelection" id="speakerSelectionInput">
                </div>

                 <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-speedometer2 me-1"></i>話速 (Speed): <span id="valSpeed"><%= userSettings.speed || 1.0 %></span></label>
                        <input type="range" class="form-range" name="speed" min="0.5" max="2.0" step="0.1" value="<%= userSettings.speed || 1.0 %>" oninput="document.getElementById('valSpeed').innerText = this.value">
                    </div>
                    <div class="col-md-6 mb-3">
                     <label class="form-label"><i class="bi bi-sliders me-1"></i>ピッチ (Pitch): <span id="valPitch"><%= userSettings.pitch || 0.0 %></span></label>
                        <input type="range" class="form-range" name="pitch" min="-0.15" max="0.15" step="0.01" value="<%= userSettings.pitch || 0.0 %>" oninput="document.getElementById('valPitch').innerText = this.value">
                    </div>
                </div>
                <div class="form-check form-switch mb-2">
                     <input class="form-check-input" type="checkbox" id="autoJoin" name="autoJoin" <%= userSettings.auto_join ? 'checked' : '' %>>
                    <label class="form-check-label" for="autoJoin">
                        <i class="bi bi-person-check me-1"></i>自動接続 (個人追従) <small class="text-muted">- あなたがVCに入るとBotも入ります</small>
                    </label>
                </div>
                
                </div>
        </div>

        <% if (isGuildAdmin) { %>
        <div class="card border-danger">
            <div class="card-header text-danger"><i class="bi bi-globe me-2"></i>サーバー設定 <span class="admin-badge">Admin Only</span></div>
            <div class="card-body">
                <div class="form-check form-switch mb-2">
                     <input class="form-check-input" type="checkbox" id="serverAutoJoin" name="serverAutoJoin" <%= guildSettings.auto_join_enabled ? 'checked' : '' %>>
                    <label class="form-check-label" for="serverAutoJoin">
                        <i class="bi bi-robot me-1"></i>サーバー自動接続 <small class="text-muted">- 誰かがVCに入るとBotが接続します</small>
                    </label>
                </div>
         
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="readJoin" name="readJoin" <%= guildSettings.read_join ? 'checked' : '' %>>
                            <label class="form-check-label" for="readJoin"><i class="bi bi-box-arrow-in-right me-1"></i>入室読み上げ</label>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="readLeave" name="readLeave" <%= guildSettings.read_leave ? 'checked' : '' %>>
                            <label class="form-check-label" for="readLeave"><i class="bi bi-box-arrow-right me-1"></i>退出読み上げ</label>
                        </div>
                    </div>
                </div>

                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="serverActiveSpeech" name="serverActiveSpeech" <%= guildSettings.active_speech ? 'checked' : '' %>>
                    <label class="form-check-label" for="serverActiveSpeech">
                        <i class="bi bi-mic-mute me-1"></i>ActiveSpeech (会話優先モード) <small class="text-muted">- 誰かが発話中の間、読み上げを待機します</small>
                    </label>
                </div>
    
         </div>
        </div>
        <% } %>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-save me-2"></i>設定を保存</button>
        </div>
    </form>
    
    <div class="mt-3 text-end">
        <form action="/dashboard/<%= guild.id %>/reset" method="POST" onsubmit="return confirm('あなたの個人設定（話者・速度・ピッチ）をデフォルトに戻しますか？');">
             <button type="submit" class="btn btn-outline-secondary btn-sm">設定をリセット</button>
        </form>
    </div>

    <hr class="border-secondary my-5">

    <% if (presets.length > 0) { %>
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-muted text-uppercase small fw-bold m-0"><i class="bi bi-collection-play me-2"></i>保存済みプリセット</h6>
            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#savePresetModal">
                 <i class="bi bi-plus-lg me-1"></i>新規作成
            </button>
        </div>

        <div class="row g-3">
            <% presets.forEach(preset => { 
                let speakerName = 'Unknown';
                let styleName = '';
                const allSpeakers = [...speakers.map(s=>({...s, type:'voicevox'})), ...ojtSpeakers.map(s=>({...s, type:'ojt'}))];
                const sp = allSpeakers.find(s => s.type === (preset.speaker_type || 'voicevox') && s.styles.some(st => st.id === preset.speaker_id));
                if (sp) {
                    speakerName = sp.name;
                    const st = sp.styles.find(s => s.id === preset.speaker_id);
                    if (st) styleName = st.name;
                }
            %>
            <div class="col-md-6 col-xl-4">
                <div class="card h-100 border-secondary">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                             <h5 class="card-title text-truncate mb-0" title="<%= preset.name %>">
                                <i class="bi bi-bookmark-fill text-info me-2"></i><%= preset.name %>
                            </h5>
                             <div class="dropdown">
                                <button class="btn btn-sm btn-link text-light p-0" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="openEditModal('<%= preset.id %>', '<%= preset.name %>', '<%= preset.speaker_type || 'voicevox' %>', '<%= preset.speaker_id %>', '<%= preset.speed %>', '<%= preset.pitch %>')"><i class="bi bi-pencil me-2"></i>編集</a></li>
                                    <li>
                                         <form action="/dashboard/<%= guild.id %>/preset/delete" method="POST" onsubmit="return confirm('削除しますか？');">
                                            <input type="hidden" name="presetId" value="<%= preset.id %>">
                                            <button type="submit" class="dropdown-item text-danger"><i class="bi bi-trash me-2"></i>削除</button>
                                        </form>
                                     </li>
                                </ul>
                            </div>
                        </div>
                        <p class="card-text small text-muted mb-3">
                            <%= speakerName %> (<%= styleName %>)<br>
                            <span class="badge bg-dark border border-secondary">Speed: <%= preset.speed %></span>
                             <span class="badge bg-dark border border-secondary">Pitch: <%= preset.pitch %></span>
                        </p>
                        <form action="/dashboard/<%= guild.id %>/preset/load" method="POST">
                             <input type="hidden" name="presetId" value="<%= preset.id %>">
                            <button type="submit" class="btn btn-outline-light btn-sm w-100">
                                <i class="bi bi-play-fill me-1"></i>ロード (適用)
                             </button>
                        </form>
                    </div>
                </div>
            </div>
            <% });
            %>
        </div>
    </div>
    <% } %>

</div>